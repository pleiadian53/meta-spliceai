# F1-based PR Analysis for MetaSpliceAI Gene CV Results

## Overview

The `f1_pr_analysis_merged.py` script provides comprehensive F1-based analysis of MetaSpliceAI gene-aware cross-validation (CV) results. This utility was specifically designed to work with the output from meta-model training and evaluation workflows.

## Purpose

This script addresses two critical analysis needs:

1. **F1-Optimized PR Curves**: Generate precision-recall curves that highlight F1 score optimization points instead of just average precision
2. **FP/FN Trade-off Analysis**: Understand the strategic trade-offs between false positives and false negatives in meta-model predictions

## Target Input Format

The script is designed to work seamlessly with gene CV results directories such as:
```
results/gene_cv_pc_1000_3mers_run_4/
```

### Required Input Files

The script expects the following files in the results directory:

#### **PR Curve Data** (Generated by CV evaluation)
- `pr_donor.csv` - Precision-recall data for donor sites
- `pr_acceptor.csv` - Precision-recall data for acceptor sites  
- `pr_neither.csv` - Precision-recall data for neither/background sites

#### **Fold Metrics** (Generated by CV training)
- `metrics_fold0.json` - Metrics for fold 0
- `metrics_fold1.json` - Metrics for fold 1
- `metrics_fold2.json` - Metrics for fold 2
- `metrics_fold3.json` - Metrics for fold 3
- `metrics_fold4.json` - Metrics for fold 4
- (Script auto-detects up to 10 folds)

#### **Optional Files**
- `cv_metrics_visualization/cv_metrics_summary.txt` - Summary statistics

## Usage

### Basic Usage
```bash
python scripts/f1_pr_analysis_merged.py results/gene_cv_pc_1000_3mers_run_4
```

### With Custom Output Directory
```bash
python scripts/f1_pr_analysis_merged.py results/gene_cv_pc_1000_3mers_run_4 analysis_output/
```

## Output Files

The script generates the following outputs:

### **1. F1-Optimized PR Curves**
- **File**: `pr_curves_f1_optimized.pdf`
- **Content**: Precision-recall curves with F1 contour lines and maximum F1 points marked
- **Features**:
  - Color-coded curves for donor, acceptor, and neither classes
  - F1 contour lines at 0.5, 0.7, 0.8, 0.9, 0.95 levels
  - Maximum F1 points clearly marked with circles
  - Legend showing maximum F1 scores for each class

### **2. Analysis Summary Report**
- **File**: `f1_pr_analysis_summary.txt`
- **Content**: Comprehensive text summary including:
  - FP/FN trade-off analysis
  - Maximum F1 scores by class
  - Strategic insights about model behavior
  - Overall performance metrics

### **3. Console Output**
The script provides detailed console output including:
- Individual fold analysis with FP/FN changes
- Strategic analysis of precision/recall trade-offs
- F1 score summaries by class
- Biological interpretation of results

## Key Features

### **1. Strategic FP/FN Analysis**
The script analyzes whether increases in false positives are strategic trade-offs:

```
‚úÖ The meta model is making a STRATEGIC TRADE-OFF:
   ‚Ä¢ Sacrificing some precision (more FPs)
   ‚Ä¢ Gaining much more recall (fewer FNs)
   ‚Ä¢ This is often desirable in splice site prediction
```

### **2. Biological Context**
Provides biological interpretation of why certain trade-offs make sense:
- False negatives (missing splice sites) are often more costly
- Missing splice sites can break gene annotation
- Extra predictions can be filtered in downstream analysis

### **3. F1 Score Optimization**
Highlights the maximum F1 score achievable for each class:
```
üìä F1 Score Summary:
Class      Max F1   Precision  Recall  
Donor      0.847    0.823      0.872   
Acceptor   0.831    0.798      0.867   
Neither    0.892    0.901      0.883   
```

## Integration with MetaSpliceAI Workflow

### **When to Use This Script**

1. **After Gene CV Training**: Run this script after completing gene-aware cross-validation
2. **Model Evaluation**: Use to understand meta-model performance characteristics
3. **Result Interpretation**: Help interpret apparent contradictions (e.g., FP increase with F1 improvement)
4. **Publication Preparation**: Generate publication-quality F1-optimized PR curves

### **Workflow Integration**
```bash
# 1. Run gene CV training
python meta_spliceai/splice_engine/meta_models/training/run_gene_cv_sigmoid.py

# 2. Analyze results with F1-based PR analysis
python scripts/f1_pr_analysis_merged.py results/gene_cv_pc_1000_3mers_run_X

# 3. Review generated plots and summary
```

## Dependencies

The script uses only standard scientific Python libraries:
- `pandas` - Data manipulation
- `numpy` - Numerical operations
- `matplotlib` - Plotting
- `sklearn.metrics` - F1 score calculations
- `json` - JSON file parsing
- `pathlib` - Path operations

## Technical Details

### **F1 Score Calculation**
```python
F1 = 2 √ó (Precision √ó Recall) / (Precision + Recall)
```

### **F1 Contour Lines**
The script generates F1 contour lines using the mathematical relationship:
```python
Precision = F1 √ó Recall / (2 √ó Recall - F1)
```

### **Strategic Analysis Logic**
The script categorizes model behavior into:
- **Precision/Recall Trade-off**: More FPs, fewer FNs (often optimal)
- **Both Improved**: Fewer FPs and FNs (ideal outcome)
- **Mixed Results**: Requires deeper analysis

## Example Output Interpretation

### **Successful Strategic Trade-off**
```
Total FP Change: +1,247
Total FN Change: -3,891
Net Error Reduction: -2,644

Strategy: precision_recall_tradeoff
‚úÖ The meta model is making a STRATEGIC TRADE-OFF
```

This indicates the meta-model is successfully prioritizing recall (finding more true splice sites) at the cost of some precision, resulting in overall better performance.

### **Ideal Improvement**
```
Total FP Change: -523
Total FN Change: -1,156
Net Error Reduction: -1,679

Strategy: both_improved
üéØ EXCELLENT: Both FPs and FNs reduced!
```

This indicates the meta-model improved both precision and recall simultaneously.

## Troubleshooting

### **Missing PR Data Files**
```
‚ùå Missing PR data for donor
‚ùå Missing PR data for acceptor
```
**Solution**: Ensure the CV evaluation generated PR curve data files.

### **No Fold Metrics Found**
```
‚ùå No fold metrics found. Cannot analyze FP/FN trade-off.
```
**Solution**: Verify that `metrics_foldX.json` files exist in the results directory.

### **Empty F1 Scores**
**Solution**: Check that PR CSV files contain valid precision and recall columns.

## Related Scripts

- `run_gene_cv_sigmoid.py` - Generates the input data for this script
- `cv_evaluation.py` - Alternative evaluation framework
- Original scripts that were merged:
  - `generate_f1_curves.py` - F1 curve generation (now integrated)
  - `generate_f1_pr_analysis.py` - FP/FN analysis (now integrated)

## Version History

- **v1.0**: Merged script combining F1 curve generation and FP/FN analysis
- **Features**: Self-contained, comprehensive analysis, biological interpretation
- **Compatibility**: Designed for gene CV output format from MetaSpliceAI meta-model training

---

**Note**: This script was created to address the specific need for F1-based analysis of gene-aware cross-validation results from MetaSpliceAI meta-model training workflows. It provides both technical metrics and biological interpretation to help understand model behavior and performance trade-offs.
