# GRCh37 Data Consistency Plan

**Date**: November 1, 2025  
**Status**: ğŸ”„ IN PROGRESS  
**Goal**: Ensure all coordinate-based datasets are consistent with GRCh37

## Overview

After fixing three critical bugs (path issues #1, #2 and data corruption #3), we are now regenerating **all** GRCh37-derived datasets from scratch to ensure complete consistency.

## Source Files (Verified Correct)

These are the authoritative source files for GRCh37:

| File | Size | Date | Status |
|------|------|------|--------|
| `Homo_sapiens.GRCh37.87.gtf` | 1.1 GB | Nov 1 00:30 | âœ… VERIFIED |
| `Homo_sapiens.GRCh37.dna.primary_assembly.fa` | 2.9 GB | Nov 1 00:30 | âœ… VERIFIED |

**Location**: `data/ensembl/GRCh37/`

## Derived Datasets to Regenerate

All of these files contain genomic coordinates and **must** be regenerated from the GRCh37 source files:

### 1. Core Annotation Files

#### `annotations.db`
- **Purpose**: SQLite database with gene/transcript/exon annotations
- **Contains**: `start`, `end` columns (genomic coordinates)
- **Why build-specific**: Coordinates differ between GRCh37 and GRCh38
- **Generated by**: `extract_annotations()` from GTF
- **Status**: ğŸ”„ Regenerating

#### `splice_sites.tsv`
- **Purpose**: Splice site positions for all transcripts
- **Contains**: `position`, `start`, `end` columns (genomic coordinates)
- **Why build-specific**: Splice site coordinates differ between builds
- **Generated by**: `extract_splice_sites_workflow()` from GTF
- **Status**: ğŸ”„ Regenerating
- **Schema**:
  ```
  chrom, start, end, position, strand, site_type, gene_id, transcript_id
  ```

#### `splice_sites_enhanced.tsv`
- **Purpose**: Splice sites with additional gene/transcript metadata
- **Contains**: All columns from `splice_sites.tsv` PLUS:
  - `gene_type` (e.g., protein_coding, lncRNA)
  - `transcript_type`
  - `gene_name`
  - Other metadata from `gene_features.tsv` and `transcript_features.tsv`
- **Why build-specific**: Inherits coordinates from `splice_sites.tsv`
- **Generated by**: `enhance_splice_sites_with_features()` 
- **Depends on**:
  - `splice_sites.tsv` (coordinates)
  - `gene_features.tsv` (metadata)
  - `transcript_features.tsv` (metadata)
- **Status**: â³ PENDING (generate after splice_sites.tsv)
- **Note**: This is the **preferred** file for analysis as it includes biotype filtering capabilities

### 2. Genomic Feature Files

#### `gene_features.tsv`
- **Purpose**: Gene-level features and coordinates
- **Contains**: `start`, `end`, `length` columns (genomic coordinates)
- **Why build-specific**: Gene boundaries differ between builds
- **Generated by**: Derived from `annotations.db` and GTF
- **Status**: ğŸ”„ Regenerating

#### `exon_features.tsv`
- **Purpose**: Exon-level features and coordinates
- **Contains**: `start`, `end` columns (genomic coordinates)
- **Why build-specific**: Exon boundaries differ between builds
- **Generated by**: Derived from `annotations.db` and GTF
- **Status**: ğŸ”„ Regenerating

#### `transcript_features.tsv`
- **Purpose**: Transcript-level features
- **Contains**: May contain coordinate-based features
- **Why build-specific**: Transcript structures differ between builds
- **Generated by**: Derived from `annotations.db` and GTF
- **Status**: ğŸ”„ Regenerating

### 3. Sequence Files

#### `gene_sequence_*.parquet`
- **Purpose**: Extracted DNA sequences for each gene
- **Contains**: Sequences extracted using genomic coordinates
- **Why build-specific**: Sequences are extracted from build-specific FASTA using build-specific coordinates
- **Generated by**: `extract_genomic_sequences()` from FASTA + GTF
- **Status**: ğŸ”„ Regenerating
- **Files**: One per chromosome (e.g., `gene_sequence_21.parquet`, `gene_sequence_22.parquet`)

### 4. Overlapping Gene Data

#### `overlapping_genes.tsv` / `overlapping_gene_counts.tsv`
- **Purpose**: Identify genes with overlapping genomic regions
- **Contains**: Gene pairs with overlapping coordinates
- **Why build-specific**: Overlap relationships depend on genomic coordinates
- **Generated by**: `find_overlapping_genes()` from GTF
- **Status**: ğŸ”„ Regenerating

## Workflow Execution

### Current Run
```bash
python scripts/setup/run_grch37_full_workflow.py \
  --chromosomes 21,22 \
  --test-mode \
  --verbose
```

**Configuration**:
- `do_extract_annotations=True` âœ…
- `do_extract_splice_sites=True` âœ…
- `do_extract_sequences=True` âœ…
- `do_find_overlaping_genes=True` âœ…

**Log file**: `grch37_test_chr21_22_CLEAN.log`

### Post-Generation Steps

After the workflow completes, we need to:

1. **Generate Enhanced Splice Sites**:
   ```python
   from meta_spliceai.splice_engine.meta_models.analysis.enhancement_utils import generate_enhanced_splice_sites
   
   enhanced_df = generate_enhanced_splice_sites(
       input_path="data/ensembl/GRCh37/splice_sites.tsv",
       output_path="data/ensembl/GRCh37/splice_sites_enhanced.tsv",
       verbose=1
   )
   ```

2. **Verify Data Consistency**:
   ```python
   import polars as pl
   
   # Load data
   gene_df = pl.read_parquet("data/ensembl/GRCh37/gene_sequence_21.parquet")
   ss_df = pl.read_csv("data/ensembl/GRCh37/splice_sites.tsv", separator="\t")
   
   # Check consistency
   for gene_id in gene_df["gene_id"].unique()[:10]:
       gene_info = gene_df.filter(pl.col("gene_id") == gene_id)
       gene_ss = ss_df.filter(pl.col("gene_id") == gene_id)
       
       gene_start = gene_info["start"][0]
       gene_end = gene_info["end"][0]
       
       # Verify all splice sites fall within gene boundaries
       for pos in gene_ss["position"]:
           assert gene_start <= pos <= gene_end, \
               f"Gene {gene_id}: splice site {pos} outside range {gene_start}-{gene_end}"
   
   print("âœ… All splice sites are within gene boundaries!")
   ```

3. **Update Registry Configuration**:
   Ensure `configs/genomic_resources.yaml` points to the correct files:
   ```yaml
   GRCh37:
     build: GRCh37
     release: 87
     data_root: data/ensembl
     gtf: Homo_sapiens.GRCh37.87.gtf
     fasta: Homo_sapiens.GRCh37.dna.primary_assembly.fa
     
     derived:
       splice_sites: splice_sites_enhanced.tsv  # Prefer enhanced version
       splice_sites_basic: splice_sites.tsv     # Basic version
       annotations_db: annotations.db
       gene_features: gene_features.tsv
       exon_features: exon_features.tsv
       transcript_features: transcript_features.tsv
   ```

## Data Consistency Validation

### Level 1: Path Consistency
âœ… All files in `data/ensembl/GRCh37/`
âœ… No cross-contamination from GRCh38

### Level 2: Coordinate Consistency
- [ ] Splice sites fall within gene boundaries
- [ ] Gene sequences match gene coordinate ranges
- [ ] Exon boundaries align with gene boundaries
- [ ] No "out of range" errors during evaluation

### Level 3: Content Consistency
- [ ] Same number of genes across all files
- [ ] Same gene IDs across all files
- [ ] Consistent chromosome naming (21 vs chr21)
- [ ] Consistent strand notation (+/-)

## File Relationships

```
Source Files:
  Homo_sapiens.GRCh37.87.gtf
  Homo_sapiens.GRCh37.dna.primary_assembly.fa
         â†“
Core Annotations:
  annotations.db â† extract_annotations(GTF)
  splice_sites.tsv â† extract_splice_sites(GTF)
         â†“
Enhanced Annotations:
  splice_sites_enhanced.tsv â† enhance(splice_sites.tsv + gene_features.tsv)
         â†“
Genomic Features:
  gene_features.tsv â† derive(annotations.db)
  exon_features.tsv â† derive(annotations.db)
  transcript_features.tsv â† derive(annotations.db)
         â†“
Sequences:
  gene_sequence_*.parquet â† extract(FASTA + GTF coordinates)
         â†“
Analysis:
  overlapping_genes.tsv â† find_overlaps(GTF)
```

## Key Differences: splice_sites.tsv vs splice_sites_enhanced.tsv

| Feature | splice_sites.tsv | splice_sites_enhanced.tsv |
|---------|------------------|---------------------------|
| **Coordinates** | âœ… Yes | âœ… Yes (same as basic) |
| **Gene metadata** | âŒ No | âœ… Yes (gene_type, gene_name) |
| **Transcript metadata** | âŒ No | âœ… Yes (transcript_type) |
| **Biotype filtering** | âŒ No | âœ… Yes (can filter by gene_type) |
| **File size** | Smaller (~6 MB) | Larger (~136 MB) |
| **Use case** | Basic predictions | Analysis, filtering, variant impact |
| **Preferred for** | Quick tests | Production analysis |

**Recommendation**: Use `splice_sites_enhanced.tsv` for all production workflows as it enables:
- Filtering to protein-coding genes only
- Biotype-specific analysis
- Richer variant impact assessment

## Timeline

1. **Nov 1 13:45** - Started workflow with full extraction
2. **Nov 1 14:15** (estimated) - Workflow completes (chr21, chr22)
3. **Nov 1 14:20** - Generate `splice_sites_enhanced.tsv`
4. **Nov 1 14:25** - Run validation checks
5. **Nov 1 14:30** - Update Registry configuration
6. **Nov 1 14:35** - Re-run test to verify everything works

## Success Criteria

- âœ… All files generated successfully
- âœ… No coordinate mismatch errors
- âœ… Splice sites within gene boundaries
- âœ… Workflow completes without errors
- âœ… F1 scores improve (target: â‰¥0.7, ideally â‰¥0.8)
- âœ… PR-AUC improves (target: closer to 0.97)

## Related Documentation

- [Bug #1: splice_sites.tsv Path](./CRITICAL_BUG_SPLICE_SITES_PATH_2025-11-01.md)
- [Bug #2: annotations.db Path](./CRITICAL_BUG_ANNOTATIONS_DB_2025-11-01.md)
- [Bug #3: Data Corruption](./CRITICAL_BUG_DATA_CORRUPTION_2025-11-01.md)
- [Multi-Build Support](../development/MULTI_BUILD_SUPPORT_COMPLETE_2025-11-01.md)
- [Registry Refactor](../development/REGISTRY_REFACTOR_2025-11-01.md)

---

**Status**: ğŸ”„ Workflow in progress, monitoring for completion



