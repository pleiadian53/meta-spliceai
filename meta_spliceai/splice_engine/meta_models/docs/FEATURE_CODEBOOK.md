# MetaSpliceAI Meta-Model: Feature Codebook

This document provides a detailed description of the features used to train the MetaSpliceAI meta-model. These features are generated by the workflow defined in `splice_prediction_workflow.py`, which leverages `enhanced_workflow.py` and `enhanced_evaluation.py`.

## Feature Categories

The features are grouped into the following categories:

1.  **Raw & Derived Probability Features**: Scores from the base predictor and direct calculations based on them.
2.  **Context-Aware & Signal Shape Features**: Metrics that describe the probability landscape around a candidate site.
3.  **Cross-Type Features**: Direct comparisons between donor and acceptor signals at the same position.
4.  **Genomic & Structural Features**: High-level information about the gene, transcript, and sequence context.
5.  **Sequence Motif Features**: Counts of short DNA sequences (k-mers).

---

## 1. Raw & Derived Probability Features

These features capture the direct output of the base splice predictor and the immediate relationships between the predicted probabilities.

| Feature | Description |
| :--- | :--- |
| `donor_score` | **Raw Score**: The probability of the position being a donor site, as predicted by the base model. |
| `acceptor_score` | **Raw Score**: The probability of the position being an acceptor site, as predicted by the base model. |
| `neither_score` | **Raw Score**: The probability of the position not being a splice site. |
| `relative_donor_probability` | The donor score as a fraction of the sum of donor and acceptor scores. Helps normalize the signal. |
| `probability_entropy` | Measures the uncertainty of the three-score probability distribution. A low value indicates a confident prediction for one class. |
| `splice_probability` | The sum of the donor and acceptor scores, representing the total probability of the site being any kind of splice site. |
| `splice_neither_diff` | The absolute difference between `splice_probability` and `neither_score`. |
| `splice_neither_logodds` | The log-odds ratio between the combined splice probability and the neither probability. |

## 2. Context-Aware & Signal Shape Features

These features are critical for distinguishing true, sharp signal peaks from noisy, ambiguous predictions. They analyze the scores in a window of 5 positions centered on the candidate site (positions -2, -1, 0, +1, +2).

*Note: Most features are calculated independently for both `donor` and `acceptor` signals. The `[type]` prefix should be replaced with either `donor` or `acceptor`.* 

| Feature (`[type]`) | Description |
| :--- | :--- |
| `[type]_is_local_peak` | **Signal Peak**: A binary flag (0 or 1) indicating if the score at the central position is the maximum within its 5-position window. |
| `[type]_signal_strength` | **Signal Sharpness**: The absolute difference between the central score and the average score of its four neighbors. Measures how much the peak stands out. |
| `[type]_peak_height_ratio` | **Signal-to-Noise**: The ratio of the central score to the average score of its neighbors. Quantifies the sharpness of the peak. |
| `[type]_second_derivative` | **Signal Curvature**: An approximation of the signal's curvature at the central point. Sharp peaks have a large negative second derivative. |
| `[type]_context_diff_ratio` | The ratio of the difference between the scores at +1 and -1 to their sum. Measures local slope/asymmetry. |
| `[type]_surge_ratio` | The ratio of the central score to the maximum score of its four neighbors. Similar to peak height ratio but more robust to low-noise floors. |
| `[type]_weighted_context` | A weighted average of the scores in the context window, giving more weight to closer positions. |
| `[type]_diff_m1`, `_m2`, `_p1`, `_p2` | The difference between the central score and the score at the specified relative position (-1, -2, +1, or +2). |
| `context_score_m1`, `_m2`, `_p1`, `_p2` | The raw probability score at the specified relative position. These are generic and used to calculate other context features. |
| `context_neighbor_mean` | The average score of the four neighbors (positions -2, -1, +1, +2). |
| `context_max` | The maximum score within the 5-position context window. |

## 3. Cross-Type Features

These features directly compare the donor and acceptor signals at the same location, helping the model differentiate between the two splice site types.

| Feature | Description |
| :--- | :--- |
| `donor_acceptor_diff` | The absolute difference between the donor and acceptor scores. |
| `donor_acceptor_logodds` | The log-odds ratio between the donor and acceptor scores. |
| `donor_acceptor_peak_ratio` | The ratio of the donor peak height ratio to the acceptor peak height ratio. Compares the sharpness of the two signals. |
| `signal_strength_ratio` | The ratio of the donor signal strength to the acceptor signal strength. |
| `context_asymmetry` | A measure of whether the context signal is stronger on the upstream or downstream side. |
| `score_difference_ratio` | The ratio of the difference between donor and acceptor scores to their sum. |
| `type_signal_difference` | The difference between the donor and acceptor weighted context scores. |

## 4. Genomic & Structural Features

These features provide high-level biological context about the location of the splice site.

| Feature | Description |
| :--- | :--- |
| `chrom` | The chromosome where the site is located. |
| `gene_start`, `gene_end`, `gene_length` | Coordinates and total length of the parent gene. |
| `tx_start`, `tx_end`, `transcript_length` | Coordinates and total length of the parent transcript. |
| `distance_to_start`, `distance_to_end` | The distance from the splice site to the start and end of its parent transcript. |
| `num_exons`, `n_splice_sites` | The total number of exons and splice sites in the parent transcript. |
| `avg_exon_length`, `median_exon_length` | The average and median length of exons in the parent transcript. |
| `total_exon_length`, `total_intron_length` | The total length of all exons and introns in the parent transcript. |
| `gc_content` | The GC content (percentage of G and C bases) in the sequence window around the site. |
| `sequence_complexity` | A measure of the repetitiveness of the sequence window. |
| `sequence_length` | The length of the sequence window used for k-mer featurization. |
| `num_overlaps` | The number of other transcripts that overlap with this position. |
| `has_gene_info`, `has_tx_info` | Boolean flags indicating if gene or transcript information was successfully annotated. |
| `missing_transcript_feats` | The number of transcript-level features that could not be calculated. |

## 5. Sequence Motif Features (k-mers)

These features capture the underlying DNA sequence composition around a candidate splice site.

-   **Format**: `[k]mer_[sequence]`, for example, `6mer_AATTCG`.
-   **Method**: The DNA sequence in a window around the candidate site is extracted. The workflow then counts the occurrences of all possible DNA "words" of length `k` (typically k=6).
-   **Total Features**: This process generates 4,096 features for 6-mers (4^6).
-   **Purpose**: Allows the model to learn which sequence motifs are positively or negatively correlated with true splice sites, independent of the base predictor's assessment.
