# Workflow Comparison: Incremental Builder vs. FN Rescue Pipeline

This document explains **why** the incremental training-dataset builder seems to “run SpliceAI on every gene” while the FN rescue pipeline can immediately focus on the top-*N* genes, and how to choose the right entry-point for your task.

---

## 1  Starting Data Assumptions

| Aspect | Incremental Builder (`incremental_builder.py`) | FN Rescue Pipeline (`run_fn_rescue_pipeline.py`) |
|--------|-----------------------------------------------|--------------------------------------------------|
| Splice-site table available at start? | **No**. It presumes that the *enhanced* positions table (`full_splice_positions_enhanced.tsv`, with 24 probability/context features) is **absent** and must be created. | **Yes**. It loads the **baseline** SpliceAI evaluation table that already contains `pred_type` (TP/FN/FP/TN) for ~20 k protein-coding genes. |
| Needs FN counts before ranking? | **Yes**, but those counts must come **from the enhanced table** so they don’t exist until SpliceAI has run once. | **No** – the baseline table already contains FN counts, so ranking can be performed immediately. |

---

## 2  Execution Order

### Incremental Builder (with `--run-workflow`)

1. **Run `run_enhanced_splice_prediction_workflow`** for *every* candidate gene (after optional gene-type filter). This produces:
   * `full_splice_positions_enhanced.tsv`
   * `analysis_sequences_enhanced.tsv`
2. **Rank genes** according to the chosen `subset_policy` (e.g. `error_fn`) **using the enhanced table**.
3. **Build meta-model training Parquet(s)** only for the selected genes.

### FN Rescue Pipeline

1. **Load** the existing **baseline** evaluation table.
2. **Rank genes** by FN counts (or FN rate) immediately.
3. **Run `run_enhanced_splice_prediction_workflow`** only on those top-*N* genes to generate enhanced features.
4. Perform downstream rescue analysis.

---

## 3  Typical Usage Patterns

### One-off heavy run (populate enhanced table)
```bash
python -m meta_spliceai.splice_engine.meta_models.builder.incremental_builder \
       --n-genes 1 --subset-policy random --batch-size 1 \
       --gene-types protein_coding --run-workflow \
       --output-dir /tmp/dummy_build -v
```
* Runs SpliceAI on every protein-coding gene **once**.
* Builds only a trivial 1-gene Parquet, minimising extra work.

### Subsequent fast experiments
```bash
python -m meta_spliceai.splice_engine.meta_models.builder.incremental_builder \
       --n-genes 5 --subset-policy error_fn \
       --gene-types protein_coding \
       --output-dir /tmp/train_pc -v        # <-- notice: no --run-workflow
```
* Loads the already-generated enhanced table.
* Selects the 5 highest-FN genes and creates the training dataset in minutes.

### FN Rescue quick analysis
```bash
python -m meta_spliceai.splice_engine.meta_models.analysis.run_fn_rescue_pipeline \
       --top-genes 5 --gene-types protein_coding
```
* Immediately identifies top FN genes using the baseline table.
* Runs SpliceAI only on those genes.

---

## 4  Baseline splice-positions table

The shortcut ranking logic in *incremental_builder* looks for the **baseline** splice-positions file that already contains `pred_type` (TP/FN/FP/TN) but **no probability features**.

*   File name: `full_splice_positions.tsv` (generated by the standard SpliceAI evaluation workflow)
*   Default location (when you don’t pass `--eval-dir`):
    ```
    /home/bchiu/work/meta-spliceai/data/ensembl/spliceai_eval/full_splice_positions.tsv
    ```
    (i.e. `<project-root>/data/ensembl/spliceai_eval/full_splice_positions.tsv`)
*   If this file is present the builder can rank genes immediately and run the enhanced workflow only on the selected subset. If it is missing the builder must first run SpliceAI once to create it.

---

## 5  Can the Builder “skip the heavy first run”?
Yes, **if** another module (e.g. the FN rescue pipeline) has already generated `full_splice_positions_enhanced.tsv` in the `eval_dir`. In that case simply omit `--run-workflow` and the builder will behave exactly like the FN rescue script: load the existing table → rank → build.

---

## 5  Summary

*The apparent discrepancy is due to the different starting datasets.*

• **Builder** assumes the enhanced table is missing and therefore runs SpliceAI first.
• **FN Rescue** relies on a baseline table that already holds FN counts.

Once the enhanced table exists, the builder can iterate just as quickly as the FN rescue pipeline.
