# Meta Learning for Splice Site Prediction: Data Leakage Analysis and Correlation Insights

## Executive Summary

This document presents a formal analysis of feature-target correlations in our meta learning approach for splice site prediction, with specific focus on the data leakage detection system implemented in our gene-aware and chromosome-aware cross-validation frameworks.

## 1. Background and Context

### 1.1 Meta Learning Framework
Our meta learning system builds upon base SpliceAI predictions to improve splice site classification through:
- **Gene-aware Cross-Validation**: Ensures no gene appears in both training and test sets
- **Chromosome-aware Cross-Validation**: Ensures no chromosome appears in both training and test sets
- **Feature Engineering**: Combines base model outputs with genomic context features
- **Multi-class Classification**: Distinguishes between donor sites, acceptor sites, and non-splice sites

### 1.2 Data Leakage Concerns
In meta learning, data leakage represents a critical threat to model validity where:
- Features inadvertently contain information about the target variable
- Model performance appears artificially inflated due to leaked information
- Generalization to truly unseen data is compromised

## 2. Correlation Analysis Framework

### 2.1 Methodology
The correlation plot generated by our leakage analysis system employs:

**Statistical Methods:**
- **Pearson Correlation**: Measures linear relationships between features and binary splice/non-splice labels
- **Spearman Correlation**: Captures monotonic relationships, robust to outliers
- **Threshold-based Detection**: Features with |correlation| ≥ 0.95 flagged as potentially leaky

**Visualization Components:**
1. **Top Feature Correlations (Left Panel)**: Horizontal bar chart showing absolute correlations for top-N features
2. **Correlation Distribution (Right Panel)**: Histogram showing the distribution of all feature correlations
3. **Statistical Significance Plot**: Scatter plot of correlation magnitude vs. p-values
4. **Leaky Features Detail**: Focused visualization of features exceeding the threshold

### 2.2 Color Coding System
- **Red bars/points**: Features exceeding the leakage threshold (|correlation| ≥ 0.95)
- **Blue bars/points**: Features below the leakage threshold
- **Red dashed line**: Threshold boundary (typically 0.95)

## 3. Interpretation Framework

### 3.1 Expected vs. Concerning Correlations

**Expected High Correlations (Legitimate):**
- `donor_score`: Base model donor probability - naturally correlated with donor sites
- `acceptor_score`: Base model acceptor probability - naturally correlated with acceptor sites
- `donor_acceptor_diff`: Difference between donor and acceptor scores
- `max_score`: Maximum of donor/acceptor scores
- `splice_confidence`: Derived confidence metrics

**Concerning High Correlations (Potential Leakage):**
- Position-specific features that encode ground truth
- Sequence features that directly reveal splice motifs
- Metadata features that contain label information
- Duplicate or near-duplicate features

### 3.2 Threshold Interpretation
- **|correlation| > 0.99**: Likely indicates actual leakage or feature duplication
- **0.95 ≤ |correlation| ≤ 0.99**: Expected for derived features from base model outputs
- **0.90 ≤ |correlation| < 0.95**: Strong but potentially legitimate relationships
- **|correlation| < 0.90**: Generally acceptable correlation levels

## 4. Meta Learning Implications

### 4.1 Base Model Feature Legitimacy
High correlations with base model features are **expected and legitimate** because:
- Meta learning explicitly builds upon base model predictions
- The goal is to correct base model errors while preserving correct predictions
- Features like `donor_score` and `acceptor_score` should correlate with splice types
- The meta model learns to weight and combine these signals appropriately

### 4.2 Feature Engineering Validation
The correlation analysis validates our feature engineering by showing:
- **Informative Features**: High-correlation features provide strong signal
- **Redundancy Detection**: Near-perfect correlations (>0.99) suggest feature redundancy
- **Signal Quality**: Distribution shape indicates feature informativeness

### 4.3 Cross-Validation Integrity
The leakage analysis ensures:
- **Temporal Consistency**: No future information leaks into training
- **Spatial Consistency**: No target-site information encoded in features
- **Methodological Rigor**: Systematic detection of problematic features

## 5. Practical Decision Framework

### 5.1 Feature Retention Criteria
**Retain features with high correlation if:**
- They represent legitimate base model outputs
- They capture biologically meaningful relationships
- They improve meta model performance on held-out data
- Their high correlation is explainable and expected

**Remove features with high correlation if:**
- They contain ground truth information
- They represent data collection artifacts
- They show perfect or near-perfect correlation (>0.99) with other features
- They cannot be computed for truly unseen data

### 5.2 Automated Decision Rules
Our system implements:
- **Automatic flagging** at correlation threshold ≥ 0.95
- **Manual review** for correlations between 0.90-0.95
- **Automatic exclusion** option for correlations > 0.99
- **Whitelist capability** for known legitimate high-correlation features

## 6. Quality Assurance Framework

### 6.1 Multi-Method Validation
- **Pearson vs. Spearman comparison**: Detects non-linear relationships
- **Cross-validation consistency**: Ensures leakage detection across folds
- **Biological plausibility**: Manual review of high-correlation features

### 6.2 Continuous Monitoring
- **Pre-training analysis**: Detect leakage before model training
- **Post-training validation**: Verify model performance is not artificially inflated
- **Feature importance correlation**: Ensure important features are not leaky

## 7. Conclusions and Best Practices

### 7.1 Key Insights
1. **Expected High Correlations**: Base model features should show strong correlations
2. **Systematic Detection**: Automated analysis prevents inadvertent leakage
3. **Biological Validation**: High correlations must be biologically interpretable
4. **Cross-validation Protection**: Gene-aware and chromosome-aware splits prevent leakage

### 7.2 Recommendations
1. **Threshold Tuning**: Adjust correlation thresholds based on feature types
2. **Feature Categorization**: Separate base model features from genomic features
3. **Manual Review**: Always manually inspect high-correlation features
4. **Documentation**: Maintain clear justification for retained high-correlation features

### 7.3 Future Directions
- **Dynamic Thresholding**: Adaptive thresholds based on feature categories
- **Causal Analysis**: Beyond correlation to understand causal relationships
- **Ensemble Validation**: Multiple correlation methods for robust detection
- **Biological Knowledge Integration**: Incorporate domain expertise in leakage detection

---

## Appendix: Technical Implementation

### A.1 Code Integration Points
- **Gene CV**: `run_gene_cv_sigmoid.py` - Line ~847 (leakage checking)
- **Chromosome CV**: `run_loco_cv_multiclass_scalable.py` - Line ~847 (leakage checking)
- **Analysis Module**: `leakage_analysis.py` - Comprehensive correlation analysis
- **Visualization**: `correlation_analysis_{method}.png` - Generated plots

### A.2 Output Files
- `feature_label_correlations.csv`: Complete correlation report
- `correlation_analysis_pearson.png`: Pearson correlation visualization
- `correlation_analysis_spearman.png`: Spearman correlation visualization
- `leaky_features_pearson.png`: Detailed view of potentially leaky features
- `method_overlap.png`: Comparison between correlation methods

### A.3 Command Line Usage
```bash
# Gene-aware CV with leakage checking
python -m meta_spliceai.splice_engine.meta_models.training.run_gene_cv_sigmoid \
    --dataset train_pc_1000/master \
    --out-dir results/gene_cv_analysis \
    --check-leakage \
    --leakage-threshold 0.95 \
    --auto-exclude-leaky

# Chromosome-aware CV with leakage checking  
python -m meta_spliceai.splice_engine.meta_models.training.run_loco_cv_multiclass_scalable \
    --dataset train_pc_1000/master \
    --out-dir results/loco_cv_analysis \
    --check-leakage \
    --leakage-threshold 0.95
```

This framework ensures robust, interpretable, and scientifically sound meta learning for splice site prediction while maintaining the highest standards of methodological rigor. 