<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Instance Training Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .mermaid {
            text-align: center;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .description {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .description h3 {
            color: #495057;
            margin-top: 0;
        }
        .description p {
            color: #6c757d;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Multi-Instance Ensemble Training Flow</h1>
        
        <div class="mermaid">
%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#e1f5fe',
    'primaryTextColor': '#01579b',
    'primaryBorderColor': '#0277bd',
    'lineColor': '#0288d1',
    'secondaryColor': '#f3e5f5',
    'tertiaryColor': '#e8f5e8',
    'background': '#ffffff',
    'mainBkg': '#e3f2fd',
    'secondBkg': '#f1f8e9',
    'tertiaryBkg': '#fff3e0'
  }
}}%%

graph TD
    A["ğŸ—‚ï¸ Large Dataset<br/>9,280 genes<br/>3.7M positions"] --> B["ğŸ¯ Enhanced Strategy Selection"]
    B --> C{"ğŸ“Š Dataset Size Analysis"}
    
    C -->|Small-Medium| D["ğŸ”§ Single Model Training<br/>â‰¤2,000 genes"]
    C -->|Large + --train-all-genes| E["ğŸš€ Multi-Instance Ensemble<br/>7 instances, 1,500 genes each"]
    
    E --> F1["ğŸ“¦ Instance 1<br/>Genes 1-1,500<br/>Complete Training Pipeline"]
    E --> F2["ğŸ“¦ Instance 2<br/>Genes 1,350-2,850<br/>10% Overlap"]
    E --> F3["ğŸ“¦ Instance 3<br/>Genes 2,700-4,200<br/>10% Overlap"]
    E --> F4["ğŸ“¦ Instances 4-7<br/>Complete Coverage"]
    
    F1 --> G1["ğŸ¯ Meta-Model 1<br/>CV + SHAP + Calibration"]
    F2 --> G2["ğŸ¯ Meta-Model 2<br/>CV + SHAP + Calibration"]
    F3 --> G3["ğŸ¯ Meta-Model 3<br/>CV + SHAP + Calibration"]
    F4 --> G4["ğŸ¯ Meta-Models 4-7<br/>CV + SHAP + Calibration"]
    
    G1 --> H["ğŸ”— Model Consolidation<br/>Weighted Voting Ensemble"]
    G2 --> H
    G3 --> H
    G4 --> H
    
    H --> I["ğŸª ConsolidatedMetaModel<br/>Unified Interface"]
    I --> J["âš¡ Inference Workflow<br/>Single Model API"]

    %% Styling for different node types
    classDef datasetNode fill:#e3f2fd,stroke:#0277bd,stroke-width:3px,color:#01579b
    classDef strategyNode fill:#f1f8e9,stroke:#388e3c,stroke-width:2px,color:#1b5e20
    classDef decisionNode fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#e65100
    classDef instanceNode fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#880e4f
    classDef modelNode fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px,color:#1a237e
    classDef consolidationNode fill:#e0f2f1,stroke:#00695c,stroke-width:3px,color:#004d40
    classDef finalNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#4a148c

    class A datasetNode
    class B,D strategyNode
    class C decisionNode
    class E strategyNode
    class F1,F2,F3,F4 instanceNode
    class G1,G2,G3,G4 modelNode
    class H consolidationNode
    class I,J finalNode
        </div>

        <div class="description">
            <h3>ğŸ¯ Multi-Instance Ensemble Training Overview</h3>
            <p>
                This diagram illustrates the complete Multi-Instance Ensemble Training workflow for MetaSpliceAI meta-models. 
                The system automatically selects between single model training (for smaller datasets) and multi-instance ensemble 
                training (for large datasets with --train-all-genes flag). Each instance trains a complete meta-model with 
                cross-validation, SHAP analysis, and calibration, then all instances are consolidated into a unified model 
                that provides 100% gene coverage while maintaining memory efficiency.
            </p>
            <p>
                <strong>Key Benefits:</strong> 100% gene coverage, memory efficiency (12-15 GB per instance vs >64 GB single model), 
                ensemble robustness, and seamless unified interface for inference.
            </p>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
